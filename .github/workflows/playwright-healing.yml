name: Playwright Tests with Shifty Heal

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  test:
    name: Run Playwright Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      tests_failed: ${{ steps.playwright.outputs.tests_failed }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        working-directory: ./demo
        run: npm ci
        
      - name: Install Playwright browsers
        working-directory: ./demo
        run: npx playwright install --with-deps chromium
        
      - name: Run Playwright tests
        id: playwright
        working-directory: ./demo
        run: npm test -- --reporter=html,json,list || echo "tests_failed=true" >> $GITHUB_OUTPUT
        env:
          CI: true
          
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            demo/playwright-report/
            demo/test-results/
          retention-days: 7
          
  heal:
    name: Auto-Heal Failed Tests
    needs: test
    if: always() && needs.test.outputs.tests_failed == 'true'
    # Use custom runner with pre-installed Ollama for faster CI
    # runs-on: [self-hosted, shifty-heal, ollama]  # Uncomment if using self-hosted runners
    runs-on: ubuntu-latest  # Standard GitHub runner with composite action
    timeout-minutes: 20
    outputs:
      fixes_applied: ${{ steps.heal.outputs.fixes_applied }}
      fixed_count: ${{ steps.heal.outputs.fixed_count }}
      avg_confidence: ${{ steps.heal.outputs.avg_confidence }}
      fix_summary: ${{ steps.heal.outputs.fix_summary }}
      failure_reason: ${{ steps.heal.outputs.failure_reason }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Healing Environment
        uses: ./.github/actions/setup-healing-environment
        with:
          ollama-model: 'qwen2.5-coder:3b'
          skip-model-pull: 'false'
          
      - name: Start Shifty Heal Engine
        run: |
          # Note: healing-engine container communicates with Ollama on localhost:11434
          docker run -d \
            --name shifty-heal-engine \
            -p 8080:8080 \
            -e HEALING_LLM_PROVIDER=ollama \
            -e HEALING_LLM_MODEL=qwen2.5-coder:3b \
            -e OLLAMA_ENDPOINT=http://host.docker.internal:11434 \
            -e HEALING_STORAGE=memory \
            -e HEALING_TELEMETRY_ENABLED=${{ vars.HEALING_TELEMETRY_ENABLED || 'false' }} \
            --add-host=host.docker.internal:host-gateway \
            coglabs/shifty-heal:latest || echo "Healing engine not yet available"
            
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: ./
      
      - name: Install script dependencies
        run: npm install @octokit/rest axios
          
      - name: Analyze failures and generate fixes
        id: heal
        working-directory: ./demo
        run: |
          # Parse test results and invoke healing engine
          node ../scripts/analyze-and-heal.js
        env:
          HEALING_ENGINE_URL: http://localhost:8080
          HEALING_MIN_CONFIDENCE: ${{ vars.HEALING_MIN_CONFIDENCE || '0.6' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Commit healed tests
        if: steps.heal.outputs.fixes_applied == 'true'
        run: |
          git config --local user.email "shifty-heal[bot]@users.noreply.github.com"
          git config --local user.name "Shifty Heal Bot"
          
          git add demo/tests/
          
          git commit -m "fix: auto-heal failing tests via Shifty Healing Engine

          ü§ñ Automated healing applied to ${{ steps.heal.outputs.fixed_count }} test(s)
          
          **Fixes Applied:**
          ${{ steps.heal.outputs.fix_summary }}
          
          **Average Confidence:** ${{ steps.heal.outputs.avg_confidence }}%
          
          ---
          Generated by Shifty Heal
          Telemetry: ${{ vars.HEALING_TELEMETRY_ENABLED || 'Disabled' }}"
          
      - name: Push changes
        if: steps.heal.outputs.fixes_applied == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.head_ref || github.ref }}
          
      - name: Comment on PR
        if: steps.heal.outputs.fixes_applied == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fixSummary = process.env.FIX_SUMMARY;
            const avgConfidence = parseFloat(process.env.AVG_CONFIDENCE);
            const confidenceBadge = avgConfidence >= 80 ? 'üü¢ High' : avgConfidence >= 50 ? 'üü° Medium' : 'üî¥ Low';
            
            const telemetryStatus = process.env.TELEMETRY_ENABLED === 'true' ? 'Enabled' : 'Disabled';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                '## ü§ñ Shifty Healing Engine',
                '',
                '**Status:** ‚úÖ Tests auto-healed and committed to this branch',
                '',
                `**Fixed Tests:** ${process.env.FIXED_COUNT}`,
                `**Average Confidence:** ${confidenceBadge} ${avgConfidence}%`,
                '',
                '### Fixes Applied:',
                fixSummary,
                '',
                '### Next Steps:',
                '- Review the healing commit in this PR',
                '- Verify tests pass in the next run',
                '- Approve and merge if fixes look correct',
                '',
                '### Validation:',
                'Each fix was validated with 3 successful test runs before committing.',
                '',
                '---',
                `üìä **Telemetry:** ${telemetryStatus} ¬∑ [Help improve healing models](https://shifty.dev/oss/telemetry)`,
                'üîß **Powered by:** [Shifty Heal](https://github.com/shifty-ai/shifty-heal) ¬∑ Model: qwen2.5-coder:3b'
              ].join('\n')
            });
        env:
          FIX_SUMMARY: ${{ steps.heal.outputs.fix_summary }}
          AVG_CONFIDENCE: ${{ steps.heal.outputs.avg_confidence }}
          FIXED_COUNT: ${{ steps.heal.outputs.fixed_count }}
          TELEMETRY_ENABLED: ${{ vars.HEALING_TELEMETRY_ENABLED }}
            
      - name: Notify if healing failed
        if: steps.heal.outputs.fixes_applied == 'false' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const failureReason = process.env.FAILURE_REASON || 'Confidence threshold not met or no fixable issues detected';
            const minConfidence = process.env.MIN_CONFIDENCE || '60';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                '## ü§ñ Shifty Healing Engine',
                '',
                '**Status:** ‚ö†Ô∏è Unable to auto-heal tests',
                '',
                `**Reason:** ${failureReason}`,
                '',
                '### Manual Review Required:',
                "The healing engine analyzed the failures but couldn't generate high-confidence fixes.",
                '',
                '### Possible Reasons:',
                '- Test failures are due to application bugs (not test issues)',
                `- Confidence scores below threshold (${minConfidence}%)`,
                '- Complex failures requiring human analysis',
                '',
                'Please review the test failures manually.',
                '',
                '---',
                'üîß **Powered by:** [Shifty Heal](https://github.com/shifty-ai/shifty-heal)'
              ].join('\n')
            });
        env:
          FAILURE_REASON: ${{ steps.heal.outputs.failure_reason }}
          MIN_CONFIDENCE: ${{ vars.HEALING_MIN_CONFIDENCE }}
            
  verify:
    name: Verify Healed Tests
    needs: heal
    if: needs.heal.outputs.fixes_applied == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout healed code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        working-directory: ./demo
        run: npm ci
        
      - name: Install Playwright browsers
        working-directory: ./demo
        run: npx playwright install --with-deps chromium
        
      - name: Run tests again to verify fixes
        working-directory: ./demo
        run: npm test
        env:
          CI: true
          
      - name: Comment verification result
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const success = process.env.JOB_STATUS === 'success';
            const emoji = success ? '‚úÖ' : '‚ùå';
            const status = success ? 'PASSED' : 'FAILED';
            const successMessage = success ? 'All tests are now passing! ‚ú®' : 'Some tests are still failing. The healing engine may need another iteration or manual intervention may be required.';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                `## ${emoji} Healing Verification: ${status}`,
                '',
                'The healed tests have been re-run to verify the fixes.',
                '',
                `**Result:** ${status}`,
                successMessage,
                '',
                '---',
                'Check the workflow run for detailed test results.'
              ].join('\n')
            });
        env:
          JOB_STATUS: ${{ job.status }}
