# Custom GitHub Actions Runner with Pre-installed Ollama and qwen2.5-coder:3b
# This significantly reduces CI run time by pre-caching the LLM model

FROM ubuntu:22.04

# Prevent interactive prompts during installation
ENV DEBIAN_FRONTEND=noninteractive
ENV OLLAMA_MODELS=/root/.ollama/models

# Install base dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    jq \
    build-essential \
    libssl-dev \
    ca-certificates \
    gnupg \
    lsb-release \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 20.x
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && npm install -g npm@latest

# Install Docker CLI (for Docker-in-Docker support)
RUN install -m 0755 -d /etc/apt/keyrings \
    && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg \
    && chmod a+r /etc/apt/keyrings/docker.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null \
    && apt-get update \
    && apt-get install -y docker-ce-cli \
    && rm -rf /var/lib/apt/lists/*

# Install Ollama
RUN curl -fsSL https://ollama.com/install.sh | sh

# Pre-pull qwen2.5-coder:3b model (saves 5-10 minutes per CI run)
RUN ollama serve & \
    OLLAMA_PID=$! && \
    sleep 10 && \
    ollama pull qwen2.5-coder:3b && \
    kill $OLLAMA_PID || true

# Install GitHub Actions Runner
ARG RUNNER_VERSION=2.311.0
RUN useradd -m github && \
    cd /home/github && \
    curl -o actions-runner-linux-x64-${RUNNER_VERSION}.tar.gz -L https://github.com/actions/runner/releases/download/v${RUNNER_VERSION}/actions-runner-linux-x64-${RUNNER_VERSION}.tar.gz && \
    tar xzf ./actions-runner-linux-x64-${RUNNER_VERSION}.tar.gz && \
    rm actions-runner-linux-x64-${RUNNER_VERSION}.tar.gz && \
    chown -R github:github /home/github

# Install Playwright system dependencies
RUN npx playwright install-deps chromium

# Create startup script
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "ðŸš€ Starting Shifty Heal Custom Runner..."\n\
\n\
# Start Ollama in background\n\
echo "ðŸ“¦ Starting Ollama service..."\n\
ollama serve > /var/log/ollama.log 2>&1 &\n\
OLLAMA_PID=$!\n\
\n\
# Wait for Ollama to be ready\n\
for i in {1..30}; do\n\
  if curl -s http://localhost:11434/api/version > /dev/null 2>&1; then\n\
    echo "âœ… Ollama ready"\n\
    break\n\
  fi\n\
  sleep 1\n\
done\n\
\n\
# Verify model is available\n\
echo "ðŸ” Verifying qwen2.5-coder:3b model..."\n\
ollama list | grep -q "qwen2.5-coder:3b" && echo "âœ… Model ready" || (echo "âŒ Model not found" && exit 1)\n\
\n\
# Start GitHub Actions runner\n\
cd /home/github\n\
./config.sh --url https://github.com/${GITHUB_REPOSITORY} --token ${RUNNER_TOKEN} --name ${RUNNER_NAME:-shifty-heal-runner} --labels shifty-heal,ollama,qwen2.5-coder --work _work --replace\n\
./run.sh\n\
' > /usr/local/bin/start-runner.sh && chmod +x /usr/local/bin/start-runner.sh

USER github
WORKDIR /home/github

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:11434/api/version || exit 1

ENTRYPOINT ["/usr/local/bin/start-runner.sh"]
